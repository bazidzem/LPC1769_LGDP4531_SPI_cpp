###########################################################################
# Makefile header and help message
###########################################################################
help:
	@echo '                                                                                   '
	@echo ' Dawid Bazan <dawidbazan@gmail.com>                                                '
	@echo ' Dariusz Synowiec <devemouse@gmail.com>                                            '
	@echo '                                                                                   '
	@echo ' Last update on May 2011                                                           '
	@echo '                                                                                   '
	@echo ' Supported commands:                                                               '
	@echo '  make all   : Build software                                                      '
	@echo '  make clean : Clean out files generated by make all command                       '
	@echo '  make flash : Flash microcontroller with compiled software  - not implemented yet '
	@echo '  make doc   : Generate Doxygen documentation - not implemented yet                '
	@echo '  make help  : this help message                                                   '
	@echo '                                                                                   '
	@echo ' Files are generated in release folder                                             '

###########################################################################
# Tool chain files and shell commands
###########################################################################
TCHAIN_PREFIX = arm-none-eabi-
CC      = $(TCHAIN_PREFIX)gcc
CPP     = $(TCHAIN_PREFIX)g++
LD      = $(TCHAIN_PREFIX)ld
AR      = $(TCHAIN_PREFIX)ar
OBJCOPY = $(TCHAIN_PREFIX)objcopy
OBJDUMP = $(TCHAIN_PREFIX)objdump
SIZE    = $(TCHAIN_PREFIX)size
NM      = $(TCHAIN_PREFIX)nm

###########################################################################
# Output path definitions
###########################################################################
# Directory for output files (lst, obj, dep, elf, sym, map, hex, bin etc.)
OUTDIR = release
OUTOBJDIR = $(OUTDIR)/obj
OUTDEPDIR = $(OUTDIR)/dep
OUTLSTDIR = $(OUTDIR)/lst
LOGDIR = $(OUTDIR)/log

# Target file name
TARGET = lpc1769

###########################################################################
# included makefiles, input path definitions
###########################################################################
include sources.mk
include rules.mk

# Add all subfolders with source codes and includes to the makefile path
VPATH = $(SUBDIRS)

# Define all object files based on source files to be compiled
OBJS = $(CSRCS:.c=.o) \
       $(CSRCSARM:.c=.o) \
       $(CPPSRCS:.cpp=.o) \
       $(CPPSRCSARM:.cpp=.o)\
       $(ASRCS:.s=.o) \
       $(ASRCSARM:.s=.o)

###########################################################################
# Compiler/Linker rules selection depending on file group
###########################################################################
$(CSRCS:.c=.o)        : CFLAGS   = @$(CFLAGS_SUB) @$(CONLYFLAGS_SUB) $(THUMB)
$(CPPSRCS:.cpp=.o)    : CPPFLAGS = @$(CFLAGS_SUB) @$(CPPFLAGS_SUB) $(THUMB)
$(ASRCS:.s=.o)        : ASFLAGS  = @$(ASFLAGS_SUB) $(THUMB)
$(CSRCSARM:.c=.o)     : CFLAGS   = @$(CFLAGS_SUB) @$(CONLYFLAGS_SUB)
$(CPPSRCSARM:.cpp=.o) : CPPFLAGS = @$(CFLAGS_SUB) @$(CPPFLAGS_SUB)
$(ASRCSARM:.s=.o)     : ASFLAGS  = @$(ASFLAGS_SUB)
LDFLAGS = @$(LDFLAGS_SUB)

###########################################################################
# Targets
###########################################################################
# Default target.
all: makefile createdirs gccversion begin build size
	@echo '---- $(TARGET) built:'

# Begin message
begin:
	@echo '---- Compiling:'

# Create output directories.
createdirs:
	-@mkdir $(OUTDIR) 2>/dev/null || echo "" >/dev/null
	-@mkdir $(OUTDEPDIR) 2>/dev/null || echo "" >/dev/null
	-@mkdir $(OUTLSTDIR) 2>/dev/null || echo "" >/dev/null
	-@mkdir $(OUTOBJDIR) 2>/dev/null || echo "" >/dev/null
	-@mkdir $(LOGDIR) 2>/dev/null || echo "" >/dev/null
	-@mkdir $(DOCDIR) 2>/dev/null || echo "" >/dev/null

# Display compiler version information.
gccversion : 
	@echo ' '
	@$(CC) --version

# Build all outputs
build: $(FLAGS_SUB) elf hex bin lss sym

# Output files to be build
elf: $(OUTDIR)/$(TARGET).elf
lss: $(OUTDIR)/$(TARGET).lss 
sym: $(OUTDIR)/$(TARGET).sym
hex: $(OUTDIR)/$(TARGET).hex
bin: $(OUTDIR)/$(TARGET).bin

# Calculate sizes of sections
size: build
	@echo ' '	
	@echo '---- Calculating size of sections in elf file:'
	$(SIZE) -A -d $(OUTDIR)/$(TARGET).elf
	

# Target: clean project.
clean:
	@echo '---- Cleaning:'
	$(RM) $(OUTDIR)/$(TARGET).map
	$(RM) $(OUTDIR)/$(TARGET).elf
	$(RM) $(OUTDIR)/$(TARGET).hex
	$(RM) $(OUTDIR)/$(TARGET).bin
	$(RM) $(OUTDIR)/$(TARGET).sym
	$(RM) $(OUTDIR)/$(TARGET).lss
	$(RM) $(OUTOBJDIR)/*.o >/dev/null 2>&1
	$(RM) $(OUTLSTDIR)/*.lst >/dev/null 2>&1
	$(RM) $(OUTDEPDIR)/*.d >/dev/null 2>&1
	$(RM) $(FLAGS_SUB) 
	@echo ' '
	@echo '---- Cleaned'

# TBD: flash
# use following dependencies after implementing this target
#flash: $(OUTDIR)/$(TARGET).elf
flash:
	$(error Flashing with OPENOCD NOT IMPLEMETED)
	#$(OOCD_EXE) $(OOCD_CL)

doc: createdirs
	doxygen doxyfile

###########################################################################
# Build release files
###########################################################################
# Create final output file (.hex) from ELF output file.
$(OUTDIR)/%.hex: $(OUTDIR)/%.elf
	@echo ' '
	@echo '---- Creating HEX file: ' $@
	$(OBJCOPY) -O ihex $< $@
	
# Create final output file (.bin) from ELF output file.
$(OUTDIR)/%.bin: $(OUTDIR)/%.elf
	@echo ' '
	@echo '---- Creating BINARY file: ' $@
	$(OBJCOPY) -O binary $< $@

# Create extended listing file/disassambly from ELF output file.
# using objdump testing: option -C
$(OUTDIR)/%.lss: $(OUTDIR)/%.elf
	@echo ' '
	@echo '---- Creating Extended Listing/Disassembly file: ' $@
	$(OBJDUMP) -h -S -C -r $< > $@

# Create a symbol table from ELF output file.
$(OUTDIR)/%.sym: $(OUTDIR)/%.elf
	@echo ' '
	@echo '---- Creating SYMBOL file: ' $@
	$(NM) -n $< > $@

# Link: create ELF output file from object files.
$(OUTDIR)/%.elf: $(OBJS) $(FLAGS_SUB)
	@echo ' '
	@echo '---- Linking, creating ELF file: ' $@
	$(LD) $(LDFLAGS) $(addprefix $(OUTOBJDIR)/, $(OBJS)) --output $@

###########################################################################
# Compile
###########################################################################
%.o: %.s $(FLAGS_SUB)
	$(CC) -c $(ASFLAGS) -Wa,-adhlns=$(OUTLSTDIR)/$(subst .s,.lst,$(notdir $<)) -MD -MP -MF $(OUTDEPDIR)/$(subst .s,.d,$(notdir $<)) $< -o $@ 

%.o: %.c $(FLAGS_SUB)
	$(CC) -c $(CFLAGS) -Wa,-adhlns=$(OUTLSTDIR)/$(subst .c,.lst,$(notdir $<)) -MD -MP -MF $(OUTDEPDIR)/$(subst .c,.d,$(notdir $<)) $< -o $(OUTOBJDIR)/$@ 
	

%.o: %.cpp $(FLAGS_SUB)
	$(CC) -c $(CPPFLAGS) -Wa,-adhlns=$(OUTLSTDIR)/$(subst .cpp,.lst,$(notdir $<)) -MD -MP -MF $(OUTDEPDIR)/$(subst .cpp,.d,$(notdir $<)) $< -o $(OUTOBJDIR)/$@ 

###########################################################################
# Options for OpenOCD flash-programming
###########################################################################
# see openocd.pdf/openocd.texi for further information
############################################################TBD: adjust to linux/lpc1769
OOCD_LOADFILE+=$(OUTDIR)/$(TARGET).elf
## Open OCD exec file
OOCD_EXE=openocd
## debug level
OOCD_CL=-d0
#OOCD_CL=-d3
# interface and board/target settings (using the OOCD target-library here)
## OOCD_CL+=-f interface/jtagkey2.cfg -f target/stm32.cfg
OOCD_CL+=-f interface/jtagkey.cfg -f target/stm32.cfg
# initialize
OOCD_CL+=-c init
# enable "fast mode" - can be disabled for tests
OOCD_CL+=-c "fast enable"
# show the targets
OOCD_CL+=-c targets
# commands to prepare flash-write
OOCD_CL+= -c "reset halt"
# increase JTAG frequency a little bit - can be disabled for tests
OOCD_CL+= -c "jtag_khz 1200"
# flash-write and -verify
OOCD_CL+=-c "flash write_image erase $(OOCD_LOADFILE)" -c "verify_image $(OOCD_LOADFILE)"
# reset target
OOCD_CL+=-c "reset run"
# terminate OOCD after programming
OOCD_CL+=-c shutdown

###########################################################################
# Listing of phony targets and default target.
###########################################################################
.PHONY : all help begin size gccversion build elf hex bin lss sym clean createdirs
.DEFAULT_GOAL := all
